#include "BluetoothSerial.h"

BluetoothSerial SerialBT;

// Motor Pins
#define IN1 23
#define IN2 22
#define IN3 19
#define IN4 18
#define ENA 25
#define ENB 26

#define CH_A 0
#define CH_B 1

int speedVal = 150;

void setup() {
  Serial.begin(115200);
  SerialBT.begin("ESP32-VOICE-CAR");

  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);

  ledcSetup(CH_A, 1000, 8);
  ledcAttachPin(ENA, CH_A);

  ledcSetup(CH_B, 1000, 8);
  ledcAttachPin(ENB, CH_B);

  stopMotors();
}

void loop() {
  if (SerialBT.available()) {
    String cmd = SerialBT.readStringUntil('\n');
    cmd.trim();
    cmd.toLowerCase();

    handleCommand(cmd);
  }
}

void handleCommand(String cmd) {

  if (cmd == "forward") setMotor(HIGH, LOW, HIGH, LOW, speedVal, speedVal);
  else if (cmd == "back") setMotor(LOW, HIGH, LOW, HIGH, speedVal, speedVal);
  else if (cmd == "left") setMotor(LOW, HIGH, HIGH, LOW, 120, 200); // differential turn
  else if (cmd == "right") setMotor(HIGH, LOW, LOW, HIGH, 200, 120);
  else if (cmd == "stop") stopMotors();

  // Optional speed control
  else if (cmd.startsWith("speed")) {
    int newSpeed = cmd.substring(5).toInt();
    speedVal = constrain(newSpeed, 0, 255);
  }
}

void setMotor(int a1, int a2, int b1, int b2, int spA, int spB) {
  digitalWrite(IN1, a1);
  digitalWrite(IN2, a2);
  digitalWrite(IN3, b1);
  digitalWrite(IN4, b2);

  ledcWrite(CH_A, spA);
  ledcWrite(CH_B, spB);
}

void stopMotors() {
  ledcWrite(CH_A, 0);
  ledcWrite(CH_B, 0);

  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, LOW);
}
